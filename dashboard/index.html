<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêù Bee Hive Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-gradient {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        }
        .status-online {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-100 min-h-screen">
    
    <!-- Header -->
    <header class="bg-amber-500 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <span class="text-3xl">üêù</span>
                    Hive Monitor
                </h1>
                <div id="lastUpdate" class="text-amber-100 text-sm">
                    Loading...
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-6">
        
        <!-- Hive Cards Grid -->
        <div id="hivesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- Cards will be inserted here -->
            <div class="col-span-full text-center py-12">
                <div class="loading inline-block text-4xl mb-4">üêù</div>
                <p class="text-amber-700">Loading hives...</p>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-amber-800 mb-4">üìà Temperature History (Last 24 Hours)</h2>
            <div class="h-64">
                <canvas id="tempChart"></canvas>
            </div>
        </div>

        <!-- Recent Readings Table -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-amber-800 mb-4">üìã Recent Readings</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b-2 border-amber-200">
                            <th class="text-left py-2 px-3">Hive</th>
                            <th class="text-left py-2 px-3">üå°Ô∏è Temp</th>
                            <th class="text-left py-2 px-3">‚öñÔ∏è Weight</th>
                            <th class="text-left py-2 px-3">üïê Time</th>
                        </tr>
                    </thead>
                    <tbody id="readingsTable">
                        <tr>
                            <td colspan="4" class="text-center py-4 text-gray-500">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-amber-800 text-amber-100 py-4 mt-8">
        <div class="max-w-6xl mx-auto px-4 text-center text-sm">
            üêù Bee Hive Monitoring System | Data refreshes every 30 seconds
        </div>
    </footer>

    <script>
        // ============================================
        // CONFIGURATION - UPDATE THESE!
        // ============================================
        const SUPABASE_URL = 'https://mafzunpomznrjvdxvknc.supabase.co';
        const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY_HERE';  // ‚Üê PASTE YOUR ANON KEY HERE!
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        
        function timeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hr ago';
            return Math.floor(seconds / 86400) + ' days ago';
        }
        
        function getStatusColor(lastReading) {
            if (!lastReading) return 'bg-gray-200';
            const seconds = Math.floor((new Date() - new Date(lastReading)) / 1000);
            if (seconds < 600) return 'bg-green-500';  // Online (< 10 min)
            if (seconds < 3600) return 'bg-yellow-500'; // Warning (< 1 hr)
            return 'bg-red-500';  // Offline
        }
        
        function getStatusText(lastReading) {
            if (!lastReading) return 'No data';
            const seconds = Math.floor((new Date() - new Date(lastReading)) / 1000);
            if (seconds < 600) return 'Online';
            if (seconds < 3600) return 'Warning';
            return 'Offline';
        }

        function getTempColor(temp) {
            if (temp < 30) return 'text-blue-600';
            if (temp < 35) return 'text-green-600';
            if (temp < 38) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        // ============================================
        // API FUNCTIONS
        // ============================================
        
        async function fetchHives() {
            const response = await fetch(`${SUPABASE_URL}/rest/v1/hives?select=*`, {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            });
            return await response.json();
        }
        
        async function fetchLatestReadings() {
            // Get latest reading for each hive
            const response = await fetch(
                `${SUPABASE_URL}/rest/v1/readings?select=*,hives(name)&order=recorded_at.desc&limit=50`,
                {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                }
            );
            return await response.json();
        }
        
        async function fetchChartData() {
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
            const response = await fetch(
                `${SUPABASE_URL}/rest/v1/readings?select=*,hives(name)&recorded_at=gte.${yesterday}&order=recorded_at.asc`,
                {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                }
            );
            return await response.json();
        }
        
        // ============================================
        // RENDER FUNCTIONS
        // ============================================
        
        async function renderHiveCards() {
            const hives = await fetchHives();
            const readings = await fetchLatestReadings();
            
            // Group latest reading per hive
            const latestByHive = {};
            readings.forEach(r => {
                if (!latestByHive[r.hive_id]) {
                    latestByHive[r.hive_id] = r;
                }
            });
            
            const grid = document.getElementById('hivesGrid');
            
            if (hives.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">üêù</div>
                        <p class="text-amber-700">No hives found. Add some data!</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = hives.map(hive => {
                const reading = latestByHive[hive.id];
                const statusColor = getStatusColor(reading?.recorded_at);
                const statusText = getStatusText(reading?.recorded_at);
                const tempColor = reading ? getTempColor(reading.temperature) : 'text-gray-400';
                
                return `
                    <div class="card-gradient rounded-2xl shadow-lg p-5 border-2 border-amber-300 hover:shadow-xl transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-lg text-amber-900">üè† ${hive.name}</h3>
                                <p class="text-xs text-amber-600">${reading ? timeAgo(reading.recorded_at) : 'No data'}</p>
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="${statusColor} w-2 h-2 rounded-full ${statusText === 'Online' ? 'status-online' : ''}"></div>
                                <span class="text-xs text-amber-700">${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white/50 rounded-lg p-3 text-center">
                                <div class="text-2xl">üå°Ô∏è</div>
                                <div class="text-xl font-bold ${tempColor}">
                                    ${reading ? reading.temperature.toFixed(1) + '¬∞C' : '--'}
                                </div>
                                <div class="text-xs text-amber-600">Temp</div>
                            </div>
                            <div class="bg-white/50 rounded-lg p-3 text-center">
                                <div class="text-2xl">‚öñÔ∏è</div>
                                <div class="text-xl font-bold text-amber-800">
                                    ${reading?.weight ? reading.weight.toFixed(1) + 'kg' : '--'}
                                </div>
                                <div class="text-xs text-amber-600">Weight</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();
        }
        
        async function renderReadingsTable() {
            const readings = await fetchLatestReadings();
            const hives = await fetchHives();
            
            const hiveNames = {};
            hives.forEach(h => hiveNames[h.id] = h.name);
            
            const table = document.getElementById('readingsTable');
            
            if (readings.length === 0) {
                table.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No readings yet</td></tr>';
                return;
            }
            
            table.innerHTML = readings.slice(0, 20).map(r => `
                <tr class="border-b border-amber-100 hover:bg-amber-50">
                    <td class="py-2 px-3 font-medium">${hiveNames[r.hive_id] || 'Unknown'}</td>
                    <td class="py-2 px-3 ${getTempColor(r.temperature)}">${r.temperature?.toFixed(1) || '--'}¬∞C</td>
                    <td class="py-2 px-3">${r.weight?.toFixed(1) || '--'} kg</td>
                    <td class="py-2 px-3 text-gray-500">${timeAgo(r.recorded_at)}</td>
                </tr>
            `).join('');
        }
        
        let tempChart = null;
        
        async function renderChart() {
            const readings = await fetchChartData();
            const hives = await fetchHives();
            
            if (readings.length === 0) return;
            
            // Group by hive
            const dataByHive = {};
            hives.forEach(h => {
                dataByHive[h.id] = {
                    name: h.name,
                    data: []
                };
            });
            
            readings.forEach(r => {
                if (dataByHive[r.hive_id]) {
                    dataByHive[r.hive_id].data.push({
                        x: new Date(r.recorded_at),
                        y: r.temperature
                    });
                }
            });
            
            const colors = ['#f59e0b', '#10b981', '#3b82f6', '#ef4444'];
            
            const datasets = Object.values(dataByHive).map((hive, i) => ({
                label: hive.name,
                data: hive.data,
                borderColor: colors[i % colors.length],
                backgroundColor: colors[i % colors.length] + '20',
                tension: 0.3,
                fill: false
            }));
            
            const ctx = document.getElementById('tempChart').getContext('2d');
            
            if (tempChart) {
                tempChart.destroy();
            }
            
            tempChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperature (¬∞C)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        // ============================================
        // INITIALIZE
        // ============================================
        
        async function loadAll() {
            try {
                await renderHiveCards();
                await renderReadingsTable();
                await renderChart();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('hivesGrid').innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <p class="text-red-600 font-bold">Error loading data</p>
                        <p class="text-gray-500 text-sm mt-2">Check console for details. Make sure SUPABASE_ANON_KEY is set!</p>
                    </div>
                `;
            }
        }
        
        // Load on page load
        loadAll();
        
        // Refresh every 30 seconds
        setInterval(loadAll, 30000);
    </script>
    
    <!-- Chart.js date adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</body>
</html>
